{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Left Sidebar -->
        <div class="col-md-2 sidebar">
            <!-- File Operations Section -->
            <h4>{{ _('File Operations') }}</h4>
            <div class="d-grid gap-2">
                <button id="import-json-btn" class="btn btn-secondary">{{ _('Import from JSON') }}</button>
                <button id="export-json-btn" class="btn btn-secondary">{{ _('Export to JSON') }}</button>
            </div>
            <hr>

            <!-- Database Operations Section -->
            {% if current_user.is_authenticated %}
                <h4>{{ _('Database Operations') }}</h4>
                <div class="save-tree-form">
                    <h5>{{ _('Save Tree') }}</h5>
                    <div class="form-group mb-2">
                        <label for="tree-name">{{ _('Tree Name') }}</label>
                        <input type="text" id="tree-name" class="form-control" placeholder="{{ _('Enter tree name') }}">
                    </div>
                    <div class="form-check mb-2">
                        <input type="checkbox" id="tree-is-public" class="form-check-input">
                        <label class="form-check-label" for="tree-is-public">{{ _('Make Public') }}</label>
                    </div>
                    <button id="save-tree-btn" class="btn btn-primary w-100">{{ _('Save Tree') }}</button>
                </div>
                <hr>
            {% endif %}
            <div class="load-tree-form">
                <h5>{{ _('Load Tree from database') }}</h5>
                <input type="text" id="tree-search" class="form-control mb-2" placeholder="{{ _('Search trees...') }}">
                <div id="tree-list" class="mb-2"></div>
                <button id="load-tree-btn" class="btn btn-success w-100">{{ _('Load Tree') }}</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-7">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">{{ _('Tree Builder') }}</h2>
                <button id="visualize-tree-btn" class="btn btn-info" disabled>{{ _('Visualize Tree') }}</button>
            </div>
            <div class="tree-display border p-3 rounded" id="tree-display" style="min-height: 80vh;">
                <!-- Tree will be built here -->
            </div>
        </div>

<!-- Modal for Tree Visualization -->
<div class="modal fade" id="tree-visualizer-modal" tabindex="-1" aria-labelledby="tree-visualizer-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="tree-visualizer-modal-label">{{ _('Interactive Tree Visualization') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="tree-visualizer-container" style="width: 100%; height: 70vh;"></div>
                <script>
                    document.getElementById('tree-visualizer-modal').addEventListener('shown.bs.modal', () => {
                        const treeContainer = document.getElementById('tree-visualizer-container');
                        const treeDataString = sessionStorage.getItem('treeToVisualize');
                        if (!treeDataString) return;

                        // Clear previous content in case of race conditions
                        treeContainer.innerHTML = '';

                        const treeData = JSON.parse(treeDataString);
                        const allImages = JSON.parse(document.getElementById('images-data').textContent);

                        const buildTreantNode = (nodeData) => {
                            const image = allImages.find(img => img.id === nodeData.id) || {id: nodeData.id, name: 'Inaccessible', path: '/static/images/prohibit-bold.png'};
                            const treantNode = {
                                text: { name: image.name },
                                image: image.path.startsWith('/') ? image.path : `/pictograms/${image.path}`,
                                children: []
                            };
                            const description = nodeData.description || image.name;
                            treantNode.innerHTML = `<div class="node-content-wrapper"><img src="${treantNode.image}" /><p class="node-name">${description}</p></div>`;

                            if (nodeData.children) {
                                nodeData.children.forEach(childData => {
                                    treantNode.children.push(buildTreantNode(childData));
                                });
                            }
                            return treantNode;
                        };

                        const nodeStructure = { children: treeData.roots.map(buildTreantNode) };
                        let finalStructure = nodeStructure.children.length > 1 ? { pseudo: true, children: nodeStructure.children } : nodeStructure.children[0];

                        if (finalStructure) {
                            const chart_config = {
                                chart: {
                                    container: "#tree-visualizer-container",
                                    connectors: { type: "step" },
                                    node: { collapsable: true, HTMLclass: 'treant-node' },
                                    scrollbar: "fancy"
                                },
                                nodeStructure: finalStructure
                            };
                            new Treant(chart_config);

                            // --- RE-ADD ZOOM/PAN AND PDF EXPORT LOGIC ---
                            let scale = 1, panning = false, pointX = 0, pointY = 0, start = { x: 0, y: 0 };
                            const treantInnerContainer = treeContainer.querySelector('.Treant');

                            const setTransform = () => {
                                if (treantInnerContainer) {
                                    treantInnerContainer.style.transformOrigin = '0 0';
                                    treantInnerContainer.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
                                }
                            };

                            treeContainer.addEventListener('wheel', e => {
                                if (e.ctrlKey) {
                                    e.preventDefault();
                                    const delta = e.deltaY < 0 ? 0.1 : -0.1;
                                    scale = Math.min(Math.max(0.5, scale + delta), 4);
                                    setTransform();
                                }
                            });

                            treeContainer.addEventListener('mousedown', e => {
                                e.preventDefault();
                                panning = true;
                                start = { x: e.clientX - pointX, y: e.clientY - pointY };
                                treeContainer.style.cursor = 'grabbing';
                            });

                            window.addEventListener('mouseup', () => {
                                panning = false;
                                treeContainer.style.cursor = 'grab';
                            });

                            window.addEventListener('mousemove', e => {
                                if (!panning) return;
                                pointX = (e.clientX - start.x);
                                pointY = (e.clientY - start.y);
                                setTransform();
                            });
                            treeContainer.style.cursor = 'grab';

                            document.getElementById('export-pdf-btn').addEventListener('click', () => {
                                const originalStyle = {
                                    width: treeContainer.style.width,
                                    height: treeContainer.style.height,
                                    overflow: treeContainer.style.overflow,
                                    transform: treantInnerContainer ? treantInnerContainer.style.transform : 'none'
                                };
                                treeContainer.style.width = `${treeContainer.scrollWidth}px`;
                                treeContainer.style.height = `${treeContainer.scrollHeight}px`;
                                treeContainer.style.overflow = 'visible';
                                if (treantInnerContainer) {
                                    treantInnerContainer.style.transform = 'none';
                                }

                                html2canvas(treeContainer, { allowTaint: true, useCORS: true, width: treeContainer.scrollWidth, height: treeContainer.scrollHeight, scale: 2 })
                                    .then(canvas => {
                                        const imgData = canvas.toDataURL('image/png');
                                        const { jsPDF } = window.jspdf;
                                        const pdf = new jsPDF({ orientation: canvas.width > canvas.height ? 'l' : 'p', unit: 'pt', format: [canvas.width, canvas.height] });
                                        pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                                        pdf.save('full-tree-export.pdf');
                                    }).finally(() => {
                                        treeContainer.style.width = originalStyle.width;
                                        treeContainer.style.height = originalStyle.height;
                                        treeContainer.style.overflow = originalStyle.overflow;
                                        if (treantInnerContainer) {
                                            treantInnerContainer.style.transform = originalStyle.transform;
                                        }
                                    });
                            });
                        }
                    });
                </script>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Close') }}</button>
                <button type="button" id="export-pdf-btn" class="btn btn-primary">{{ _('Export to PDF') }}</button>
            </div>
        </div>
    </div>
</div>

        <!-- Right Sidebar -->
        <div class="col-md-3 sidebar">
            <!-- Description Section -->
            <h4>{{ _('Node Description') }}</h4>
            <div classs="form-group mb-2">
                <textarea id="node-description" class="form-control" rows="3" placeholder="{{ _('Enter node description...') }}"></textarea>
            </div>
            <hr>

            <!-- Images Section -->
            <h4>{{ _('Images') }}</h4>
            <input type="text" id="image-search" class="form-control mb-2" placeholder="{{ _('Search images...') }}">
            <div class="image-sidebar border p-3" id="image-sidebar-tree">
                <!-- The dynamic image tree will be built here -->
            </div>
            <hr>
            <div class="d-grid gap-2 mt-3">
                <button id="delete-btn" class="btn btn-danger">{{ _('Delete selected branch') }}</button>
                <button id="new-tree-btn" class="btn btn-secondary">{{ _('New tree') }}</button>
            </div>
        </div>
    </div>
</div>

<script id="initial-tree-data" type="application/json">
    {{ initial_tree_data_json | safe }}
</script>
<script id="images-data" type="application/json">
    {{ images_json | safe }}
</script>

<!-- Treant.js CSS -->
<link rel="stylesheet" href="{{ url_for('static', filename='vendor/perfect-scrollbar/perfect-scrollbar.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='vendor/Treant.css') }}">

<!-- PDF Export and Treant.js dependencies -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="{{ url_for('static', filename='vendor/raphael.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/jquery.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/jquery.mousewheel.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/perfect-scrollbar/perfect-scrollbar.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/Treant.js') }}"></script>

<script src="{{ url_for('static', filename='js/builder.js') }}"></script>
{% endblock %}
